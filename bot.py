# -*- coding: utf-8 -*-
# LivePlace Telegram Bot â€” Railway-ready (Sheets ENABLED)
# ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ bot.py Ñ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¼ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸ĞµĞ¼ Ğº Google Sheets.

import os
import re
import json
import time
import random
import asyncio
import logging
from time import monotonic
from datetime import datetime
from typing import List, Dict, Any
from collections import Counter, defaultdict
from urllib.parse import urlencode, urlparse, parse_qs, urlunparse

from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.context import FSMContext
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton, InputMediaPhoto

# == Logging ==
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger("liveplace")

# == .env ==
try:
    from dotenv import load_dotenv
    load_dotenv()
except Exception:
    pass

# == Config ==
class Config:
    API_TOKEN = os.getenv("API_TOKEN", "").strip()
    ADMIN_CHAT_ID = int(os.getenv("ADMIN_CHAT_ID", "0") or "0")

    SHEETS_ENABLED = os.getenv("SHEETS_ENABLED", "1").strip() not in {"", "0", "false", "False"}
    GSHEET_ID = os.getenv("GSHEET_ID", "").strip()
    GSHEET_TAB = os.getenv("GSHEET_TAB", "Ads").strip()
    GSHEET_REFRESH_MIN = int(os.getenv("GSHEET_REFRESH_MIN", "2") or "2")

    # Ğ ĞµĞºĞ»Ğ°Ğ¼Ğ½Ñ‹Ğµ UTM
    UTM_SOURCE = os.getenv("UTM_SOURCE", "telegram")
    UTM_MEDIUM = os.getenv("UTM_MEDIUM", "bot")
    UTM_CAMPAIGN = os.getenv("UTM_CAMPAIGN", "bot_ads")

    # Ğ ĞµĞºĞ»Ğ°Ğ¼Ğ°/Ñ‡Ğ°ÑÑ‚Ğ¾Ñ‚Ğ°
    ADS_ENABLED = os.getenv("ADS_ENABLED", "1").strip() not in {"0","false","False",""}
    ADS_PROB = float(os.getenv("ADS_PROB", "0.18"))
    ADS_COOLDOWN_SEC = int(os.getenv("ADS_COOLDOWN_SEC", "180"))

if not Config.API_TOKEN:
    raise RuntimeError("API_TOKEN is not set. Add it to Railway Variables.")

# == Bot ==
bot = Bot(token=Config.API_TOKEN, parse_mode="HTML")
dp = Dispatcher(storage=MemoryStorage())

# == Google Sheets ==
import gspread
from google.oauth2.service_account import Credentials

class SheetsManager:
    def __init__(self):
        if not Config.SHEETS_ENABLED:
            raise RuntimeError("SHEETS_ENABLED must be 1 for SheetsManager")
        creds_json = os.getenv("GOOGLE_CREDENTIALS_JSON")
        if not creds_json:
            raise RuntimeError("GOOGLE_CREDENTIALS_JSON is missing in Variables")
        creds = Credentials.from_service_account_info(
            json.loads(creds_json),
            scopes=[
                "https://www.googleapis.com/auth/spreadsheets.readonly",
                "https://www.googleapis.com/auth/drive.readonly",
            ],
        )
        self.client = gspread.authorize(creds)
        self.sheet_id = Config.GSHEET_ID
        self.tab_name = Config.GSHEET_TAB or "Ads"

    def get_rows(self) -> List[Dict[str, Any]]:
        ws = self.client.open_by_key(self.sheet_id).worksheet(self.tab_name)
        rows = ws.get_all_records()
        logger.info(f"Loaded {len(rows)} rows from Sheets [{self.tab_name}]")
        return rows

sheets = SheetsManager()

# == ĞšÑÑˆ Ğ¾Ğ±ÑŠÑĞ²Ğ»ĞµĞ½Ğ¸Ğ¹ ==
_cached_rows: List[Dict[str, Any]] = []
_cache_ts: float = 0.0
CACHE_TTL = max(1, Config.GSHEET_REFRESH_MIN) * 60

def load_rows(force: bool = False) -> List[Dict[str, Any]]:
    global _cached_rows, _cache_ts
    if not force and _cached_rows and (monotonic() - _cache_ts) < CACHE_TTL:
        return _cached_rows
    try:
        data = sheets.get_rows()
        _cached_rows = data
        _cache_ts = monotonic()
        return data
    except Exception as e:
        logger.error(f"Failed to load rows from Sheets: {e}")
        return _cached_rows or []

async def rows_async(force: bool = False) -> List[Dict[str, Any]]:
    return await asyncio.to_thread(load_rows, force)

# == Ğ›Ğ¾ĞºĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¸ Ñ‚ĞµĞºÑÑ‚Ñ‹ ==
LANGS = ["ru", "en", "ka"]
USER_LANG: Dict[int, str] = {}
LANG_MAP = {"ru":"ru","ru-RU":"ru","en":"en","en-US":"en","en-GB":"en","ka":"ka","ka-GE":"ka"}

T = {
    "menu_title": {"ru": "Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ", "en": "Main menu", "ka": "áƒ›áƒ—áƒáƒ•áƒáƒ áƒ˜ áƒ›áƒ”áƒœáƒ˜áƒ£"},
    "btn_search": {"ru": "ğŸ” ĞŸĞ¾Ğ¸ÑĞº", "en": "ğŸ” Search", "ka": "ğŸ” áƒ«áƒ˜áƒ”áƒ‘áƒ"},
    "btn_latest": {"ru": "ğŸ†• ĞĞ¾Ğ²Ñ‹Ğµ", "en": "ğŸ†• Latest", "ka": "ğŸ†• áƒáƒ®áƒáƒšáƒ˜"},
    "btn_language": {"ru": "ğŸŒ Ğ¯Ğ·Ñ‹Ğº", "en": "ğŸŒ Language", "ka": "ğŸŒ áƒ”áƒœáƒ"},
    "btn_about": {"ru": "â„¹ï¸ Ğ Ğ±Ğ¾Ñ‚Ğµ", "en": "â„¹ï¸ About", "ka": "â„¹ï¸ áƒ¨áƒ”áƒ¡áƒáƒ®áƒ”áƒ‘"},
    "btn_fast": {"ru": "ğŸŸ¢ Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ Ğ¿Ğ¾Ğ´Ğ±Ğ¾Ñ€", "en": "ğŸŸ¢ Quick picks", "ka": "ğŸŸ¢ áƒ¡áƒ¬áƒ áƒáƒ¤áƒ˜ áƒáƒ áƒ©áƒ”áƒ•áƒáƒœáƒ˜"},
    "btn_favs": {"ru": "â¤ï¸ Ğ˜Ğ·Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğµ", "en": "â¤ï¸ Favorites", "ka": "â¤ï¸ áƒ áƒ©áƒ”áƒ£áƒšáƒ”áƒ‘áƒ˜"},
    "btn_home": {"ru": "ğŸ  ĞœĞµĞ½Ñ", "en": "ğŸ  Menu", "ka": "ğŸ  áƒ›áƒ”áƒœáƒ˜áƒ£"},
    "btn_daily": {"ru": "ğŸ•“ ĞŸĞ¾ÑÑƒÑ‚Ğ¾Ñ‡Ğ½Ğ¾ ğŸ†•", "en": "ğŸ•“ Daily rent ğŸ†•", "ka": "ğŸ•“ áƒ“áƒ¦áƒ˜áƒ£áƒ áƒáƒ“ ğŸ†•"},
    "btn_rent": {"ru": "ğŸ˜ ĞÑ€ĞµĞ½Ğ´Ğ°", "en": "ğŸ˜ Rent", "ka": "ğŸ˜ áƒ¥áƒ˜áƒ áƒáƒ•áƒ“áƒ”áƒ‘áƒ"},
    "btn_sale": {"ru": "ğŸ  ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶Ğ°", "en": "ğŸ  Sale", "ka": "ğŸ  áƒ˜áƒ§áƒ˜áƒ“áƒ”áƒ‘áƒ"},
    "btn_prev": {"ru": "Â« ĞĞ°Ğ·Ğ°Ğ´", "en": "Â« Prev", "ka": "Â« áƒ£áƒ™áƒáƒœ"},
    "btn_next": {"ru": "Ğ’Ğ¿ĞµÑ€Ñ‘Ğ´ Â»", "en": "Next Â»", "ka": "áƒ¬áƒ˜áƒœ Â»"},
    "btn_like": {"ru": "â¤ï¸ ĞÑ€Ğ°Ğ²Ğ¸Ñ‚ÑÑ", "en": "â¤ï¸ Like", "ka": "â¤ï¸ áƒ›áƒáƒ›áƒ”áƒ¬áƒáƒœáƒ"},
    "btn_dislike": {"ru": "ğŸ‘ Ğ”Ğ¸Ğ·Ğ»Ğ°Ğ¹Ğº", "en": "ğŸ‘ Dislike", "ka": "ğŸ‘ áƒáƒ  áƒ›áƒáƒ›áƒ¬áƒáƒœáƒ¡"},
    "btn_fav_add": {"ru": "â­ Ğ’ Ğ¸Ğ·Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğµ", "en": "â­ Favorite", "ka": "â­ áƒ áƒ©áƒ”áƒ£áƒšáƒ”áƒ‘áƒ¨áƒ˜"},
    "btn_fav_del": {"ru": "â­ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¸Ğ· Ğ¸Ğ·Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾", "en": "â­ Remove favorite", "ka": "â­ áƒ¬áƒáƒ¨áƒšáƒ"},

    "start": {
        "ru": "<b>LivePlace</b>\nğŸ‘‹ ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! Ğ¯ Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ´Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ <b>Ğ¸Ğ´ĞµĞ°Ğ»ÑŒĞ½ÑƒÑ Ğ½ĞµĞ´Ğ²Ğ¸Ğ¶Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ² Ğ“Ñ€ÑƒĞ·Ğ¸Ğ¸</b>.\n\n<b>ĞšĞ°Ğº ÑÑ‚Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚?</b>\nâ€” Ğ—Ğ°Ğ´Ğ°Ğ¼ 3â€“4 Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ñ… Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ°\nâ€” ĞŸĞ¾ĞºĞ°Ğ¶Ñƒ Ğ»ÑƒÑ‡ÑˆĞ¸Ğµ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ñ‹ Ñ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¸ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ¾Ğ¼ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†Ğ°\nâ€” ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ? Ğ–Ğ¼Ğ¸ <b>ğŸŸ¢ Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ Ğ¿Ğ¾Ğ´Ğ±Ğ¾Ñ€</b>\n\nĞ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸ ÑƒĞ´Ğ°Ñ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ¸ÑĞºĞ°! ğŸ¡",
        "en": "<b>LivePlace</b>\nğŸ‘‹ Hi! I'll help you find <b>your ideal home in Georgia</b>.\n\n<b>How it works:</b>\nâ€” 3â€“4 quick questions\nâ€” Top options with photos & owner phone\nâ€” Just browsing? Tap <b>ğŸŸ¢ Quick picks</b>\n\nWelcome and happy hunting! ğŸ¡",
        "ka": "<b>LivePlace</b>\nğŸ‘‹ áƒ’áƒáƒ›áƒáƒ áƒ¯áƒáƒ‘áƒ! áƒ”áƒ áƒ—áƒáƒ“ áƒ•áƒ˜áƒáƒáƒ•áƒáƒ— <b>áƒ˜áƒ“áƒ”áƒáƒšáƒ£áƒ áƒ˜ áƒ‘áƒ˜áƒœáƒ áƒ¡áƒáƒ¥áƒáƒ áƒ—áƒ•áƒ”áƒšáƒáƒ¨áƒ˜</b>.\n\n<b>áƒ áƒáƒ’áƒáƒ  áƒ›áƒ£áƒ¨áƒáƒáƒ‘áƒ¡:</b>\nâ€” 3â€“4 áƒ›áƒáƒ áƒ¢áƒ˜áƒ•áƒ˜ áƒ™áƒ˜áƒ—áƒ®áƒ•áƒ\nâ€” áƒ¡áƒáƒ£áƒ™áƒ”áƒ—áƒ”áƒ¡áƒ áƒ•áƒáƒ áƒ˜áƒáƒœáƒ¢áƒ”áƒ‘áƒ˜ áƒ¤áƒáƒ¢áƒáƒ”áƒ‘áƒ˜áƒ—áƒ áƒ“áƒ áƒ›áƒ¤áƒšáƒáƒ‘áƒ”áƒšáƒ˜áƒ¡ áƒœáƒáƒ›áƒ áƒ˜áƒ—\nâ€” áƒ£áƒ‘áƒ áƒáƒšáƒáƒ“ áƒ’áƒáƒ“áƒáƒáƒ—áƒ•áƒáƒšáƒ˜áƒ”áƒ áƒ”? áƒ“áƒáƒáƒ­áƒ˜áƒ áƒ” <b>ğŸŸ¢ áƒ¡áƒ¬áƒ áƒáƒ¤áƒ˜ áƒáƒ áƒ©áƒ”áƒ•áƒáƒœáƒ˜</b>\n\náƒ™áƒ”áƒ—áƒ˜áƒšáƒ˜ áƒ˜áƒ§áƒáƒ¡ áƒ—áƒ¥áƒ•áƒ”áƒœáƒ˜ áƒ›áƒáƒ‘áƒ áƒ«áƒáƒœáƒ”áƒ‘áƒ! ğŸ¡",
    },
    "about": {
        "ru": "LivePlace: Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ Ğ¿Ğ¾Ğ´Ğ±Ğ¾Ñ€ Ğ½ĞµĞ´Ğ²Ğ¸Ğ¶Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ² Ğ“Ñ€ÑƒĞ·Ğ¸Ğ¸. Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹, 10 Ñ„Ğ¾Ñ‚Ğ¾, Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†Ğ°, Ğ¸Ğ·Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğµ.",
        "en": "LivePlace: fast real-estate search in Georgia. Filters, 10 photos, owner phone, favorites.",
        "ka": "LivePlace: áƒ£áƒ«áƒ áƒáƒ•áƒ˜ áƒ¥áƒáƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒ¡áƒ¬áƒ áƒáƒ¤áƒ˜ áƒ«áƒ˜áƒ”áƒ‘áƒ áƒ¡áƒáƒ¥áƒáƒ áƒ—áƒ•áƒ”áƒšáƒáƒ¨áƒ˜. áƒ¤áƒ˜áƒšáƒ¢áƒ áƒ”áƒ‘áƒ˜, 10 áƒ¤áƒáƒ¢áƒ, áƒ›áƒ¤áƒšáƒáƒ‘áƒ”áƒšáƒ˜áƒ¡ áƒœáƒáƒ›áƒ”áƒ áƒ˜, áƒ áƒ©áƒ”áƒ£áƒšáƒ”áƒ‘áƒ˜."
    },
}

LANG_FIELDS = {
    "ru": {"title": "title_ru", "desc": "description_ru"},
    "en": {"title": "title_en", "desc": "description_en"},
    "ka": {"title": "title_ka", "desc": "description_ka"},
}

def t(lang: str, key: str, **kw) -> str:
    lang = lang if lang in LANGS else "ru"
    val = T.get(key, {}).get(lang, T.get(key, {}).get("ru", key))
    try:
        return val.format(**kw) if kw else val
    except Exception:
        return val

def current_lang(uid: int) -> str:
    return USER_LANG.get(uid, "ru")

def main_menu(lang: str) -> ReplyKeyboardMarkup:
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text=T["btn_fast"][lang])],
            [KeyboardButton(text=T["btn_search"][lang]), KeyboardButton(text=T["btn_latest"][lang])],
            [KeyboardButton(text=T["btn_favs"][lang])],
            [KeyboardButton(text=T["btn_language"][lang]), KeyboardButton(text=T["btn_about"][lang])]
        ],
        resize_keyboard=True
    )

# == FSM ==
class Wizard(StatesGroup):
    mode = State()
    city = State()
    district = State()
    budget = State()

# == Ğ¡Ğ»Ğ¾Ğ²Ğ°Ñ€Ğ¸ Ğ´Ğ»Ñ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ¾Ğ² Ğ¸ Ñ†ĞµĞ½ ==
CITY_ICONS = {"Ğ¢Ğ±Ğ¸Ğ»Ğ¸ÑĞ¸":"ğŸ™", "Ğ‘Ğ°Ñ‚ÑƒĞ¼Ğ¸":"ğŸŒŠ", "ĞšÑƒÑ‚Ğ°Ğ¸ÑĞ¸":"ğŸ›"}
PRICE_RANGES = {
    "rent":["500","1000","1500","2000"],
    "sale":["50000","100000","150000","200000"],
    "daily":["50","100","150","200"]
}

# == ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ==
PAGE_SIZE = 8
USER_RESULTS: Dict[int, Dict[str, Any]] = {}
LAST_AD_TIME: Dict[int, float] = {}
LAST_AD_ID: Dict[int, str] = {}

# == Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹ ==
def norm(s: Any) -> str:
    return str(s or "").strip().lower()

def norm_mode(v: Any) -> str:
    s = norm(v)
    if s in {"rent","Ğ°Ñ€ĞµĞ½Ğ´Ğ°","long","long-term","Ğ´Ğ¾Ğ»Ğ³Ğ¾ÑÑ€Ğ¾Ñ‡Ğ½Ğ¾","longterm"}: return "rent"
    if s in {"sale","Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ°","buy","sell"}: return "sale"
    if s in {"daily","Ğ¿Ğ¾ÑÑƒÑ‚Ğ¾Ñ‡Ğ½Ğ¾","sutki","ÑÑƒÑ‚ĞºĞ¸","short","short-term","day"}: return "daily"
    return ""

def drive_direct(url: str) -> str:
    if not url: return url
    m = re.search(r"/d/([A-Za-z0-9_-]{20,})/", url)
    if m: return f"https://drive.google.com/uc?export=download&id={m.group(1)}"
    m = re.search(r"[?&]id=([A-Za-z0-9_-]{20,})", url)
    if m: return f"https://drive.google.com/uc?export=download&id={m.group(1)}"
    return url

def looks_like_image(url: str) -> bool:
    if not url: return False
    u = url.lower()
    return any(u.endswith(ext) for ext in (".jpg",".jpeg",".png",".webp")) or \
           "googleusercontent.com" in u or "google.com/uc?export=download" in u

def collect_photos(row: Dict[str, Any]) -> List[str]:
    out = []
    for i in range(1, 11):
        u = str(row.get(f"photo{i}", "")).strip()
        if not u: continue
        u = drive_direct(u)
        if looks_like_image(u): out.append(u)
    return out

def parse_rooms(v: Any) -> float:
    s = str(v or "").strip().lower()
    if s in {"ÑÑ‚ÑƒĞ´Ğ¸Ñ","studio","stud","áƒ¡áƒ¢áƒ£áƒ“áƒ˜áƒ"}: return 0.5
    try: return float(s.replace("+",""))
    except Exception: return -1.0

def build_utm_url(raw: str, ad_id: str, uid: int) -> str:
    if not raw: return "https://liveplace.com.ge/"
    seed = f"{uid}:{datetime.utcnow().strftime('%Y%m%d')}:{ad_id}".encode()
    token = __import__("hashlib").sha256(seed).hexdigest()[:16]
    u = urlparse(raw); q = parse_qs(u.query)
    q["utm_source"]=[Config.UTM_SOURCE]
    q["utm_medium"]=[Config.UTM_MEDIUM]
    q["utm_campaign"]=[Config.UTM_CAMPAIGN]
    q["utm_content"]=[ad_id]
    q["token"]=[token]
    new_q = urlencode({k: v[0] for k,v in q.items()})
    return urlunparse((u.scheme,u.netloc,u.path,u.params,new_q,u.fragment))

def format_card(row: Dict[str, Any], lang: str) -> str:
    title_k = LANG_FIELDS[lang]["title"]
    desc_k  = LANG_FIELDS[lang]["desc"]
    city     = str(row.get("city","")).strip()
    district = str(row.get("district","")).strip()
    rtype    = str(row.get("type","")).strip()
    rooms    = str(row.get("rooms","")).strip()
    price    = str(row.get("price","")).strip()
    published= str(row.get("published","")).strip()
    phone    = str(row.get("phone","")).strip()
    title    = str(row.get(title_k,"")).strip()
    desc     = str(row.get(desc_k,"")).strip()

    pub_txt = published
    try:
        dt = datetime.fromisoformat(published)
        pub_txt = dt.strftime("%Y-%m-%d")
    except Exception:
        pass

    txt = f"<b>{title}</b>\n"
    txt += f"{desc}\n"
    txt += f"<b>Ğ“Ğ¾Ñ€Ğ¾Ğ´:</b> {city}\n<b>Ğ Ğ°Ğ¹Ğ¾Ğ½:</b> {district}\n<b>Ğ¢Ğ¸Ğ¿:</b> {rtype}\n<b>ĞšĞ¾Ğ¼Ğ½Ğ°Ñ‚:</b> {rooms}\n<b>Ğ¦ĞµĞ½Ğ°:</b> {price}\n<b>Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½:</b> {phone}\n"
    txt += f"<i>Ğ”Ğ°Ñ‚Ğ° Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸: {pub_txt}</i>"
    return txt

# == Handlers ==

@dp.message(Command("start"))
async def cmd_start(message: types.Message, state: FSMContext):
    lang = current_lang(message.from_user.id)
    await state.clear()
    await message.answer(T["start"][lang], reply_markup=main_menu(lang))

@dp.message(F.text.in_([T["btn_fast"]["ru"],T["btn_fast"]["en"],T["btn_fast"]["ka"]]))
async def fast_pick(message: types.Message, state: FSMContext):
    await Wizard.mode.set()
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(KeyboardButton(T["btn_rent"][current_lang(message.from_user.id)]))
    kb.add(KeyboardButton(T["btn_sale"][current_lang(message.from_user.id)]))
    kb.add(KeyboardButton(T["btn_daily"][current_lang(message.from_user.id)]))
    await message.answer("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ€ĞµĞ¶Ğ¸Ğ¼ Ğ¿Ğ¾Ğ¸ÑĞºĞ°", reply_markup=kb)

@dp.message(Wizard.mode)
async def pick_mode(message: types.Message, state: FSMContext):
    mode = norm_mode(message.text)
    if not mode:
        await message.answer("ĞĞµ Ñ€Ğ°ÑĞ¿Ğ¾Ğ·Ğ½Ğ°Ğ½Ğ¾, Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ€ĞµĞ¶Ğ¸Ğ¼:")
        return
    await state.update_data(mode=mode)
    await Wizard.city.set()
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    for c in CITY_ICONS.keys():
        kb.add(KeyboardButton(f"{CITY_ICONS[c]} {c}"))
    await message.answer("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ³Ğ¾Ñ€Ğ¾Ğ´:", reply_markup=kb)

@dp.message(Wizard.city)
async def pick_city(message: types.Message, state: FSMContext):
    city = re.sub(r"^[^Ğ-Ğ¯Ğ°-ÑA-Za-z]*","", message.text).strip()
    await state.update_data(city=city)
    await Wizard.district.set()
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    # Ğ—Ğ´ĞµÑÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ğ¾Ğ´Ñ‚ÑĞ³Ğ¸Ğ²Ğ°Ñ‚ÑŒ Ñ€Ğ°Ğ¹Ğ¾Ğ½Ñ‹ Ğ¸Ğ· Sheets
    districts = ["Ğ’ĞµÑÑŒ Ğ³Ğ¾Ñ€Ğ¾Ğ´", "Ğ¦ĞµĞ½Ñ‚Ñ€", "Ğ¡Ğ°Ğ±ÑƒÑ€Ñ‚Ğ°Ğ»Ğ¾", "Ğ’ĞµÑ€Ğµ"]  # Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€
    for d in districts: kb.add(KeyboardButton(d))
    await message.answer("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ€Ğ°Ğ¹Ğ¾Ğ½ Ğ¸Ğ»Ğ¸ ĞŸÑ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ:", reply_markup=kb)

@dp.message(Wizard.district)
async def pick_district(message: types.Message, state: FSMContext):
    district = message.text.strip()
    if district.lower() in {"Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ","Ğ²ĞµÑÑŒ Ğ³Ğ¾Ñ€Ğ¾Ğ´"}:
        district = ""
    await state.update_data(district=district)
    data = await state.get_data()
    mode = data.get("mode")
    await Wizard.budget.set()
    kb = ReplyKeyboardMarkup(resize_keyboard=True)
    for p in PRICE_RANGES.get(mode, ["ĞŸÑ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ"]):
        kb.add(KeyboardButton(p))
    kb.add(KeyboardButton("ĞŸÑ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ"))
    await message.answer("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ±ÑĞ´Ğ¶ĞµÑ‚:", reply_markup=kb)

@dp.message(Wizard.budget)
async def pick_price(message: types.Message, state: FSMContext):
    budget = message.text.strip()
    if budget.lower() in {"Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ","Ğ²ĞµÑÑŒ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½"}:
        budget = ""
    await state.update_data(budget=budget)
    data = await state.get_data()
    await show_results(message.from_user.id, data, state)

# == Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ ==
async def show_results(uid: int, data: Dict[str, Any], state: FSMContext):
    rows = await rows_async()
    mode, city, district, budget = data.get("mode"), data.get("city"), data.get("district"), data.get("budget")
    filtered = []
    for r in rows:
        if mode and norm_mode(r.get("mode","")) != mode: continue
        if city and norm(r.get("city","")) != norm(city): continue
        if district and norm(r.get("district","")) != norm(district): continue
        if budget:
            try:
                if float(r.get("price",0)) > float(budget): continue
            except Exception: pass
        filtered.append(r)

    if not filtered:
        await bot.send_message(uid, "ĞŸĞ¾ Ğ²Ğ°ÑˆĞµĞ¼Ñƒ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑƒ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾.", reply_markup=main_menu(current_lang(uid)))
        await state.clear()
        return

    USER_RESULTS[uid] = {"rows": filtered, "page":0}
    await send_page(uid)

async def send_page(uid: int):
    res = USER_RESULTS.get(uid)
    if not res: return
    rows = res["rows"]
    page = res["page"]
    row = rows[page]
    lang = current_lang(uid)
    photos = collect_photos(row)
    text = format_card(row, lang)
    kb = InlineKeyboardMarkup(row_width=3)
    if page>0:
        kb.insert(InlineKeyboardButton(T["btn_prev"][lang], callback_data="prev"))
    if page<len(rows)-1:
        kb.insert(InlineKeyboardButton(T["btn_next"][lang], callback_data="next"))
    kb.add(InlineKeyboardButton(T["btn_fav_add"][lang], callback_data="fav"))
    if photos:
        media = [InputMediaPhoto(m, caption=text) for m in photos[:10]]
        await bot.send_media_group(uid, media)
        await bot.send_message(uid, "Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚:", reply_markup=kb)
    else:
        await bot.send_message(uid, text, reply_markup=kb)

@dp.callback_query(F.data.in_({"prev","next","fav"}))
async def cb_page(cq: types.CallbackQuery):
    uid = cq.from_user.id
    res = USER_RESULTS.get(uid)
    if not res: return
    if cq.data=="prev": res["page"] = max(0, res["page"]-1)
    if cq.data=="next": res["page"] = min(len(res["rows"])-1, res["page"]+1)
    await send_page(uid)
    await cq.answer()

# == Ğ—Ğ°Ğ¿ÑƒÑĞº ==
if __name__=="__main__":
    import asyncio
    from aiogram import executor
    logger.info("LivePlace bot is runningâ€¦")
    executor.start_polling(dp, skip_updates=True)
